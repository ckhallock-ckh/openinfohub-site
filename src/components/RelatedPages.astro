---
/**
 * RelatedPages.astro
 * Finds other pages under a cluster (default pest-control) that share at least one tag.
 *
 * Usage:
 *   <RelatedPages tags={tags} currentUrl={Astro.url.pathname} />
 */

const {
  tags = [],
  currentUrl = "",
  title = "Related pages",
  max = 5,
  glob = "../../pages/home/pest-control/*/index.astro",
} = Astro.props;

// Normalize tags to lowercase, trimmed
const currentTags = (Array.isArray(tags) ? tags : [])
  .map((t) => String(t).toLowerCase().trim())
  .filter(Boolean);

// Pull all guide pages from the cluster folder
const pages = await Astro.glob(glob);

const related = pages
  .map((p) => {
    const pTags = (p.frontmatter?.tags ?? [])
      .map((t) => String(t).toLowerCase().trim())
      .filter(Boolean);

    return {
      url: p.url,
      title:
        p.frontmatter?.title ??
        p.url.split("/").filter(Boolean).slice(-1)[0].replace(/-/g, " "),
      description: p.frontmatter?.description ?? "",
      tags: pTags,
    };
  })
  // exclude the current page
  .filter((x) => x.url !== currentUrl)
  // must share at least one tag
  .filter((x) => {
    if (currentTags.length === 0) return false;
    return x.tags.some((t) => currentTags.includes(t));
  })
  // simple scoring: number of shared tags
  .map((x) => ({
    ...x,
    score: x.tags.filter((t) => currentTags.includes(t)).length,
  }))
  .sort((a, b) => (b.score - a.score) || a.title.localeCompare(b.title))
  .slice(0, max);
---

{related.length ? (
  <section style="border:1px dashed #d1d5db; border-radius:12px; padding:16px; margin-bottom:18px;">
    <h2 style="margin:0 0 10px; font-size:18px;">{title}</h2>
    <ul style="margin:0; padding-left:18px;">
      {related.map((r) => (
        <li style="margin: 10px 0;">
          <a href={r.url} style="font-weight:600;">{r.title}</a>
          {r.description ? (
            <div style="color:#6b7280; font-size:13px; margin-top:4px;">
              {r.description}
            </div>
          ) : null}
        </li>
      ))}
    </ul>
  </section>
) : null}

