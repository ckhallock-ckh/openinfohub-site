---
/**
 * RelatedPages.astro
 * Tag-based related links for Astro pages.
 *
 * Usage:
 *   <RelatedPages tags={tags} currentUrl={Astro.url.pathname} />
 *
 * Notes:
 * - Uses import.meta.glob (Astro.glob is deprecated)
 * - Works after removing /home by globbing all pages under src/pages
 * - Never throws if no matches; it will simply render nothing
 */

const { tags = [], currentUrl = "", title = "Related pages", max = 5 } = Astro.props;

const currentTags = (Array.isArray(tags) ? tags : [])
  .map((t) => String(t).toLowerCase().trim())
  .filter(Boolean);

function normTags(value: any) {
  if (!value) return [];
  if (Array.isArray(value)) {
    return value.map((t) => String(t).toLowerCase().trim()).filter(Boolean);
  }
  return [String(value).toLowerCase().trim()].filter(Boolean);
}

// IMPORTANT: must be a literal for Vite/Cloudflare
// This is relative to src/components/RelatedPages.astro
// It matches ALL index.astro pages under src/pages/**/index.astro
const modules = import.meta.glob("../pages/**/index.astro", { eager: true });

// Convert modules into a list of page-like records
const pages = Object.values(modules);

// Build a related list; tolerate different export shapes
const related = pages
  .map((p: any) => {
    // Support both patterns:
    // - export const frontmatter = { ... }
    // - export const tags/title/description directly
    const fm = p.frontmatter ?? p?.default?.frontmatter ?? p; // defensive

    const pTags = normTags((fm && fm.tags) ?? p.tags);
    const pTitle = (fm && fm.title) ?? p.title ?? "Untitled";
    const pDescription = (fm && fm.description) ?? p.description ?? "";
    const pUrl = p.url ?? p?.default?.url ?? "";

    return {
      url: pUrl,
      title: pTitle,
      description: pDescription,
      tags: pTags,
    };
  })
  .filter((x) => x.url && x.url !== currentUrl)
  .filter((x) => currentTags.length > 0 && x.tags.some((t) => currentTags.includes(t)))
  .map((x) => ({
    ...x,
    score: x.tags.filter((t) => currentTags.includes(t)).length,
  }))
  .sort((a, b) => (b.score - a.score) || a.title.localeCompare(b.title))
  .slice(0, max);
---

{related.length ? (
  <section style="border:1px dashed #d1d5db; border-radius:12px; padding:16px; margin-bottom:18px;">
    <h2 style="margin:0 0 10px; font-size:18px;">{title}</h2>
    <ul style="margin:0; padding-left:18px;">
      {related.map((r) => (
        <li style="margin:10px 0;">
          <a href={r.url} style="font-weight:600;">{r.title}</a>
          {r.description ? (
            <div style="color:#6b7280; font-size:13px; margin-top:4px;">
              {r.description}
            </div>
          ) : null}
        </li>
      ))}
    </ul>
  </section>
) : null}

